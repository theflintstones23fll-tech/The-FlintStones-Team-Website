<!DOCTYPE HTML>
<html>
<head>
    <title>Score Calculator - The FlintStones</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: #e5d3b3;
            color: #4a3728;
            overflow-x: hidden;
        }

        /* Header */
        #header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #bb6401;
            border-bottom: 2px solid rgba(160, 160, 160, 0.3);
            z-index: 1000;
            padding: 0 20px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #header h1 {
            color: #fff;
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        #header h1 a {
            color: inherit;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 30px;
            list-style: none;
        }

        .nav-links a {
            color: #fff;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: #fff;
            font-size: 1.8rem;
            cursor: pointer;
        }

        /* Mobile Menu */
        .mobile-menu {
            display: none;
            position: fixed;
            top: 70px;
            left: 0;
            width: 100%;
            background: #bb6401;
            padding: 20px;
            z-index: 999;
        }

        .mobile-menu.active {
            display: block;
        }

        .mobile-menu ul {
            list-style: none;
        }

        .mobile-menu li {
            margin: 15px 0;
        }

        .mobile-menu a {
            color: #fff;
            text-decoration: none;
            font-size: 1.1rem;
            font-weight: 600;
            display: block;
        }

        /* Score Section */
        #score-section {
            padding-top: 90px;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .page-title {
            text-align: center;
            color: #4a3728;
            font-size: 2rem;
            margin-bottom: 30px;
            padding: 0 20px;
            text-transform: uppercase;
            letter-spacing: 0.2em;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Controls Section */
        .controls-section {
            background: rgba(255, 255, 255, 0.6);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            justify-content: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: bold;
            font-size: 0.9rem;
        }

        .control-group select {
            padding: 8px 12px;
            border: 2px solid #a67c52;
            background: white;
            border-radius: 5px;
            font-size: 1rem;
        }

        /* Map Section */
        .map-wrapper {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin: 0 auto 30px;
            background: #f4ece1;
            border: 6px solid #4a3728;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .map-image {
            width: 100%;
            height: auto;
            display: block;
        }

        .markers-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .marker {
            position: absolute;
            width: 35px;
            height: 35px;
            background: #a67c52;
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            cursor: pointer;
            border: 3px solid white;
            transition: all 0.3s;
            font-size: 0.9rem;
            z-index: 10;
            transform: translate(-50%, -50%);
        }

        .marker:hover {
            background: #6b8e23;
            transform: translate(-50%, -50%) scale(1.2);
        }

        /* Missions List */
        .missions-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .mission-card {
            background: #f4ece1;
            border: 3px solid #a67c52;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .mission-card h3 {
            color: #4a3728;
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #a67c52;
        }

        .mission-option {
            margin: 15px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }

        .mission-option label {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .point-tag {
            color: #6b8e23;
            font-weight: bold;
            float: right;
        }

        .mission-option select,
        .mission-option input {
            width: 100%;
            padding: 8px;
            border: 2px solid #a67c52;
            border-radius: 5px;
            background: white;
            font-size: 1rem;
        }

        /* Score Panel */
        #score-panel {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #4a3728;
            color: #f4ece1;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.5rem;
            font-weight: bold;
            border: 3px solid #d4af37;
            z-index: 100;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            #header {
                height: 70px;
                padding: 0 15px;
            }

            #header h1 {
                font-size: 1.2rem;
            }

            .nav-links {
                display: none;
            }

            .menu-toggle {
                display: block;
            }

            .page-title {
                font-size: 1.5rem;
            }

            .controls-section {
                padding: 15px;
                gap: 15px;
            }

            .marker {
                width: 30px;
                height: 30px;
                font-size: 0.8rem;
            }

            .missions-list {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            #score-panel {
                font-size: 1.2rem;
                padding: 12px 25px;
                bottom: 10px;
            }
        }

        @media (max-width: 480px) {
            #header h1 {
                font-size: 1rem;
            }

            .page-title {
                font-size: 1.2rem;
                letter-spacing: 0.1em;
            }

            .control-group {
                width: 100%;
            }

            .marker {
                width: 25px;
                height: 25px;
                font-size: 0.7rem;
                border: 2px solid white;
            }

            .mission-card {
                padding: 15px;
            }

            .mission-card h3 {
                font-size: 1rem;
            }

            #score-panel {
                font-size: 1rem;
                padding: 10px 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header id="header">
        <h1><a href="/">The FlintStones</a></h1>
        <nav>
            <ul class="nav-links">
                <li><a href="/#team">Our Team</a></li>
                <li><a href="/#project">Our Project</a></li>
                <li><a href="https://gemini.google.com/gem/1TIKnzAwIovfqnrmbvtkVpVeD7ACHvqce?usp=sharing#">FLL Chatbot</a></li>
                <li><a href="#">Score Calculator</a></li>
                <li><a href="https://fll-simulator.vercel.app/">FLL Simulation</a></li>
            </ul>
        </nav>
        <button class="menu-toggle" id="menuToggle">â˜°</button>
    </header>

    <!-- Mobile Menu -->
    <nav class="mobile-menu" id="mobileMenu">
        <ul>
            <li><a href="/#team">Our Team</a></li>
            <li><a href="/#project">Our Project</a></li>
            <li><a href="https://gemini.google.com/gem/1TIKnzAwIovfqnrmbvtkVpVeD7ACHvqce?usp=sharing">FLL Chatbot</a></li>
            <li><a href="#">Score Calculator</a></li>
            <li><a href="https://fll-simulator.vercel.app/">FLL Simulation</a></li>
        </ul>
    </nav>

    <!-- Score Section -->
    <section id="score-section">
        <h1 class="page-title">FLL Unearthed Score Calculator</h1>
        
        <div class="main-container">
            <!-- Controls -->
            <div class="controls-section">
                <div class="control-group">
                    <label for="inspect">Equipment Inspection (+20):</label>
                    <select id="inspect" onchange="calc()">
                        <option value="20">Yes</option>
                        <option value="0">No</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="precision">Precision Tokens:</label>
                    <select id="precision" onchange="calc()">
                        <option value="50">6 Tokens (50 Points)</option>
                        <option value="50">5 Tokens (50 Points)</option>
                        <option value="35">4 Tokens (35 Points)</option>
                        <option value="25">3 Tokens (25 Points)</option>
                        <option value="15">2 Tokens (15 Points)</option>
                        <option value="10">1 Token (10 Points)</option>
                        <option value="0">0 Tokens (0 Points)</option>
                    </select>
                </div>
                <div class="control-group">
                    <button class="excel-btn" onclick="exportToExcel()" style="background: #4a3728; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">ðŸ“Š Save as Excel</button>
                </div>
                <div class="control-group">
                    <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;" onchange="importFromExcel(this)">
                    <button class="excel-btn" onclick="document.getElementById('excelFile').click()" style="background: #6b8e23; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">ðŸ“‚ Load Excel</button>
                </div>
            </div>

            <!-- Map with Markers -->
            <div class="map-wrapper">
                <img class="map-image" src="../static/images/Mat.png" alt="FLL Mat">
                <div class="markers-overlay">
                    <div class="marker" style="top: 36%; left: 4%;" onclick="scrollToMission('M01')">01</div>
                    <div class="marker" style="top: 8%; left: 8%;" onclick="scrollToMission('M02')">02</div>
                    <div class="marker" style="top: 4%; left: 32%;" onclick="scrollToMission('M03')">03</div>
                    <div class="marker" style="top: 15%; left: 27%;" onclick="scrollToMission('M04')">04</div>
                    <div class="marker" style="top: 5%; left: 78%;" onclick="scrollToMission('M05')">05</div>
                    <div class="marker" style="top: 17%; left: 85%;" onclick="scrollToMission('M06')">06</div>
                    <div class="marker" style="top: 5%; left: 92%;" onclick="scrollToMission('M07')">07</div>
                    <div class="marker" style="top: 37%; left: 92%;" onclick="scrollToMission('M08')">08</div>
                    <div class="marker" style="top: 40%; left: 68%;" onclick="scrollToMission('M09')">09</div>
                    <div class="marker" style="top: 45%; left: 59%;" onclick="scrollToMission('M10')">10</div>
                    <div class="marker" style="top: 91%; left: 58%;" onclick="scrollToMission('M11')">11</div>
                    <div class="marker" style="top: 91%; left: 44%;" onclick="scrollToMission('M12')">12</div>
                    <div class="marker" style="top: 39%; left: 41%;" onclick="scrollToMission('M13')">13</div>
                    <div class="marker" style="top: 43%; left: 32%;" onclick="scrollToMission('M14')">14</div>
                    <div class="marker" style="top: 90%; left: 90%;" onclick="scrollToMission('M15')">15</div>
                </div>
            </div>

            <!-- Missions List -->
            <div class="missions-list">
                <!-- Mission 01 -->
                <div class="mission-card" id="M01">
                    <h3>Mission 01: Surface Excavation</h3>
                    <div class="mission-option">
                        <label>Cleared soil deposits: <span class="point-tag">10 pts/each</span></label>
                        <select onchange="u('m1p',this.value)">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                        </select>
                    </div>
                    <div class="mission-option">
                        <label>Brush not touching excavation area: <span class="point-tag">10 pts</span></label>
                        <select onchange="u('m1b',this.value)">
                            <option value="0">No</option>
                            <option value="10">Yes</option>
                        </select>
                    </div>
                </div>

                <!-- Mission 02 -->
                <div class="mission-card" id="M02">
                    <h3>Mission 02: Map Reveal</h3>
                    <div class="mission-option">
                        <label>Cleared topsoil sections: <span class="point-tag">10 pts/each</span></label>
                        <select onchange="u('m2',this.value)">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                </div>

                <!-- Mission 03 -->
                <div class="mission-card" id="M03">
                    <h3>Mission 03: Mine Cart Explorer</h3>
                    <div class="mission-option">
                        <label>Cart in opponent's area: <span class="point-tag">30 pts</span></label>
                        <select onchange="u('m3c',this.value)">
                            <option value="0">No</option>
                            <option value="30">Yes</option>
                        </select>
                    </div>
                    <div class="mission-option">
                        <label>Bonus: Opponent's cart with you: <span class="point-tag">10 pts</span></label>
                        <select onchange="u('m3b',this.value)">
                            <option value="0">No</option>
                            <option value="10">Yes</option>
                        </select>
                    </div>
                </div>

                <!-- Mission 04 -->
                <div class="mission-card" id="M04">
                    <h3>Mission 04: Careful Rescue</h3>
                    <div class="mission-option">
                        <label>Artifact not touching mine: <span class="point-tag">30 pts</span></label>
                        <select onchange="u('m4a',this.value)">
                            <option value="0">No</option>
                            <option value="30">Yes</option>
                        </select>
                    </div>
                    <div class="mission-option">
                        <label>Supports standing: <span class="point-tag">10 pts</span></label>
                        <select onchange="u('m4s',this.value)">
                            <option value="0">No</option>
                            <option value="10">Yes</option>
                        </select>
                    </div>
                </div>

                <!-- Mission 05 -->
                <div class="mission-card" id="M05">
                    <h3>Mission 05: Who Lived Here?</h3>
                    <div class="mission-option">
                        <label>Foundation completely face-up: <span class="point-tag">30 pts</span></label>
                        <select onchange="u('m5',this.value)">
                            <option value="0">No</option>
                            <option value="30">Yes</option>
                        </select>
                    </div>
                </div>

                <!-- Mission 06 -->
                <div class="mission-card" id="M06">
                    <h3>Mission 06: Smelter</h3>
                    <div class="mission-option">
                        <label>Blocks not touching smelter: <span class="point-tag">10 pts/each</span></label>
                        <select onchange="u('m6',this.value)">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                </div>

                <!-- Mission 07 -->
                <div class="mission-card" id="M07">
                    <h3>Mission 07: Weight Lifting</h3>
                    <div class="mission-option">
                        <label>Millstone not touching base: <span class="point-tag">30 pts</span></label>
                        <select onchange="u('m7',this.value)">
                            <option value="0">No</option>
                            <option value="30">Yes</option>
                        </select>
                    </div>
                </div>

                <!-- Mission 08 -->
                <div class="mission-card" id="M08">
                    <h3>Mission 08: Storage</h3>
                    <div class="mission-option">
                        <label>Food items outside storage: <span class="point-tag">10 pts/each</span></label>
                        <select onchange="u('m8',this.value)">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                </div>

                <!-- Mission 09 -->
                <div class="mission-card" id="M09">
                    <h3>Mission 09: What's For Sale?</h3>
                    <div class="mission-option">
                        <label>Roof completely removed: <span class="point-tag">20 pts</span></label>
                        <select onchange="u('m9r',this.value)">
                            <option value="0">No</option>
                            <option value="20">Yes</option>
                        </select>
                    </div>
                    <div class="mission-option">
                        <label>Products removed: <span class="point-tag">10 pts</span></label>
                        <select onchange="u('m9i',this.value)">
                            <option value="0">No</option>
                            <option value="10">Yes</option>
                        </select>
                    </div>
                </div>

                <!-- Mission 10 -->
                <div class="mission-card" id="M10">
                    <h3>Mission 10: Tip the Scale</h3>
                    <div class="mission-option">
                        <label>Scale tipped & touching mat: <span class="point-tag">20 pts</span></label>
                        <select onchange="u('m10t',this.value)">
                            <option value="0">No</option>
                            <option value="20">Yes</option>
                        </select>
                    </div>
                    <div class="mission-option">
                        <label>Pan completely removed: <span class="point-tag">10 pts</span></label>
                        <select onchange="u('m10k',this.value)">
                            <option value="0">No</option>
                            <option value="10">Yes</option>
                        </select>
                    </div>
                </div>

                <!-- Mission 11 -->
                <div class="mission-card" id="M11">
                    <h3>Mission 11: Fishing Artifacts</h3>
                    <div class="mission-option">
                        <label>Artifacts above level: <span class="point-tag">20 pts</span></label>
                        <select onchange="u('m11e',this.value)">
                            <option value="0">No</option>
                            <option value="20">Yes</option>
                        </select>
                    </div>
                    <div class="mission-option">
                        <label>Bonus: Flag down: <span class="point-tag">10 pts</span></label>
                        <select onchange="u('m11b',this.value)">
                            <option value="0">No</option>
                            <option value="10">Yes</option>
                        </select>
                    </div>
                </div>

                <!-- Mission 12 -->
                <div class="mission-card" id="M12">
                    <h3>Mission 12: Rescue Operation</h3>
                    <div class="mission-option">
                        <label>Sand completely cleared: <span class="point-tag">20 pts</span></label>
                        <select onchange="u('m12k',this.value)">
                            <option value="0">No</option>
                            <option value="20">Yes</option>
                        </select>
                    </div>
                    <div class="mission-option">
                        <label>Ship completely raised: <span class="point-tag">10 pts</span></label>
                        <select onchange="u('m12g',this.value)">
                            <option value="0">No</option>
                            <option value="10">Yes</option>
                        </select>
                    </div>
                </div>

                <!-- Mission 13 -->
                <div class="mission-card" id="M13">
                    <h3>Mission 13: Statue Rebuild</h3>
                    <div class="mission-option">
                        <label>Statue completely raised: <span class="point-tag">30 pts</span></label>
                        <select onchange="u('m13',this.value)">
                            <option value="0">No</option>
                            <option value="30">Yes</option>
                        </select>
                    </div>
                </div>

                <!-- Mission 14 -->
                <div class="mission-card" id="M14">
                    <h3>Mission 14: Forum</h3>
                    <div class="mission-option">
                        <label>Artifacts in forum (max 7): <span class="point-tag">5 pts/each</span></label>
                        <input type="number" min="0" max="7" value="0" onchange="u('m14',this.value)">
                    </div>
                </div>

                <!-- Mission 15 -->
                <div class="mission-card" id="M15">
                    <h3>Mission 15: Area Marking</h3>
                    <div class="mission-option">
                        <label>Marked areas (flags): <span class="point-tag">10 pts/each</span></label>
                        <select onchange="u('m15',this.value)">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Score Panel -->
    <div id="score-panel">Total: <span id="total">70</span> Points</div>

    <script src="../static/js/xlsx.full.min.js"></script>
    <script>
        const state = { 
            m1p:0, m1b:0, m2:0, m3c:0, m3b:0, m4a:0, m4s:0, m5:0, 
            m6:0, m7:0, m8:0, m9r:0, m9i:0, m10t:0, m10k:0, m11e:0, 
            m11b:0, m12k:0, m12g:0, m13:0, m14:0, m15:0 
        };
        
        // History tracking system
        let calculationHistory = [];

        function u(k, v) { 
            state[k] = parseInt(v) || 0; 
            calc(); 
        }

        function calc() {
            let t = (state.m1p*10) + state.m1b + (state.m2*10) + state.m3c + state.m3b + 
                    state.m4a + state.m4s + state.m5 + (state.m6*10) + state.m7 + 
                    (state.m8*10) + state.m9r + state.m9i + state.m10t + state.m10k + 
                    state.m11e + state.m11b + state.m12k + state.m12g + state.m13 + 
                    (state.m14*5) + (state.m15*10);
            t += parseInt(document.getElementById("inspect").value) + 
                 parseInt(document.getElementById("precision").value);
            document.getElementById("total").innerText = t;
        }

        function scrollToMission(id) {
            const element = document.getElementById(id);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                element.style.animation = 'highlight 1s';
                setTimeout(() => { element.style.animation = ''; }, 1000);
            }
        }

        // Mobile menu toggle
        const menuToggle = document.getElementById('menuToggle');
        const mobileMenu = document.getElementById('mobileMenu');

        menuToggle.addEventListener('click', () => {
            mobileMenu.classList.toggle('active');
            menuToggle.textContent = mobileMenu.classList.contains('active') ? 'âœ•' : 'â˜°';
        });

        // Close mobile menu when clicking a link
        const mobileLinks = mobileMenu.querySelectorAll('a');
        mobileLinks.forEach(link => {
            link.addEventListener('click', () => {
                mobileMenu.classList.remove('active');
                menuToggle.textContent = 'â˜°';
            });
        });

        // Add current calculation to history
        function addToHistory() {
            const now = new Date();
            const totalScore = document.getElementById("total").innerText;
            
            const currentCalculation = {
                timestamp: now.toLocaleString(),
                score: totalScore,
                state: {...state},
                inspect: document.getElementById("inspect").value,
                precision: document.getElementById("precision").value
            };
            
            calculationHistory.push(currentCalculation);
        }
        
        // Excel Export Function
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            
            // Add current calculation to history before exporting
            addToHistory();
            
            // Get current date and time
            const now = new Date();
            const totalScore = document.getElementById("total").innerText;
            
            // Create summary sheet with all calculations
            const summaryData = [
                ["FLL Unearthed Score Calculator - History"],
                ["Export Date:", now.toLocaleString()],
                ["Total Calculations:", calculationHistory.length],
                [],
                ["Date & Time", "Total Score", "Equipment Inspection", "Precision Tokens"]
            ];
            
            // Add all historical calculations
            calculationHistory.forEach(calc => {
                summaryData.push([
                    calc.timestamp,
                    calc.score,
                    calc.inspect === "20" ? "Yes" : "No",
                    document.querySelector("#precision option[value='" + calc.precision + "']").text.split(' ')[0]
                ]);
            });
            
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            summaryWs['!cols'] = [
                {wch: 20}, // Date & Time
                {wch: 12}, // Total Score
                {wch: 18}, // Equipment Inspection
                {wch: 15}  // Precision Tokens
            ];
            XLSX.utils.book_append_sheet(wb, summaryWs, "Calculation History");
            
            // Create detailed sheet for current calculation
            const missionData = [
                ["Current Calculation Details"],
                ["Date & Time:", now.toLocaleString()],
                ["Total Score:", totalScore],
                [],
                ["Mission", "Status", "Points"],
                ["Equipment Inspection", document.getElementById("inspect").value === "20" ? "Yes" : "No", document.getElementById("inspect").value],
                ["Precision Tokens", document.getElementById("precision").options[document.getElementById("precision").selectedIndex].text, document.getElementById("precision").value],
                ["M01: Surface Excavation", `Cleared: ${state.m1p}, Brush: ${state.m1b > 0 ? "Yes" : "No"}`, (state.m1p * 10) + state.m1b],
                ["M02: Map Reveal", `Sections: ${state.m2}`, state.m2 * 10],
                ["M03: Mine Cart Explorer", `Cart: ${state.m3c > 0 ? "Yes" : "No"}, Bonus: ${state.m3b > 0 ? "Yes" : "No"}`, state.m3c + state.m3b],
                ["M04: Careful Rescue", `Artifact: ${state.m4a > 0 ? "Yes" : "No"}, Supports: ${state.m4s > 0 ? "Yes" : "No"}`, state.m4a + state.m4s],
                ["M05: Who Lived Here?", state.m5 > 0 ? "Foundation Complete" : "Not Complete", state.m5],
                ["M06: Smelter", `Blocks: ${state.m6}`, state.m6 * 10],
                ["M07: Weight Lifting", state.m7 > 0 ? "Millstone Moved" : "Not Moved", state.m7],
                ["M08: Storage", `Items: ${state.m8}`, state.m8 * 10],
                ["M09: What's For Sale?", `Roof: ${state.m9r > 0 ? "Yes" : "No"}, Products: ${state.m9i > 0 ? "Yes" : "No"}`, state.m9r + state.m9i],
                ["M10: Tip the Scale", `Scale: ${state.m10t > 0 ? "Yes" : "No"}, Pan: ${state.m10k > 0 ? "Yes" : "No"}`, state.m10t + state.m10k],
                ["M11: Fishing Artifacts", `Artifacts: ${state.m11e > 0 ? "Yes" : "No"}, Flag: ${state.m11b > 0 ? "Yes" : "No"}`, state.m11e + state.m11b],
                ["M12: Rescue Operation", `Sand: ${state.m12k > 0 ? "Yes" : "No"}, Ship: ${state.m12g > 0 ? "Yes" : "No"}`, state.m12k + state.m12g],
                ["M13: Statue Rebuild", state.m13 > 0 ? "Statue Raised" : "Not Raised", state.m13],
                ["M14: Forum", `Artifacts: ${state.m14}`, state.m14 * 5],
                ["M15: Area Marking", `Areas: ${state.m15}`, state.m15 * 10],
                [],
                ["Raw Data"],
                ["State Variable", "Value"],
                ["m1p", state.m1p],
                ["m1b", state.m1b],
                ["m2", state.m2],
                ["m3c", state.m3c],
                ["m3b", state.m3b],
                ["m4a", state.m4a],
                ["m4s", state.m4s],
                ["m5", state.m5],
                ["m6", state.m6],
                ["m7", state.m7],
                ["m8", state.m8],
                ["m9r", state.m9r],
                ["m9i", state.m9i],
                ["m10t", state.m10t],
                ["m10k", state.m10k],
                ["m11e", state.m11e],
                ["m11b", state.m11b],
                ["m12k", state.m12k],
                ["m12g", state.m12g],
                ["m13", state.m13],
                ["m14", state.m14],
                ["m15", state.m15],
                ["inspect", document.getElementById("inspect").value],
                ["precision", document.getElementById("precision").value]
            ];
            
            const missionWs = XLSX.utils.aoa_to_sheet(missionData);
            missionWs['!cols'] = [
                {wch: 25}, // Mission
                {wch: 30}, // Status
                {wch: 10}  // Points
            ];
            XLSX.utils.book_append_sheet(wb, missionWs, "Current Calculation");
            
            // Generate filename with timestamp
            const fileName = `FLL_Score_History_${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}-${String(now.getMinutes()).padStart(2,'0')}.xlsx`;
            
            XLSX.writeFile(wb, fileName);
        }
        
        // Excel Import Function
        function importFromExcel(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, {type: 'array'});
                    
                    // Add current state to history before loading new data
                    addToHistory();
                    
                    // Try to load from "Calculation History" sheet first (new format)
                    if (wb.SheetNames.includes("Calculation History")) {
                        loadFromHistoryFormat(wb);
                    } 
                    // Fallback to old format
                    else if (wb.SheetNames.includes("FLL Score") || wb.SheetNames.includes("Current Calculation")) {
                        loadFromOldFormat(wb);
                    }
                    
                    // Update all form controls to match state
                    updateFormControls();
                    
                    // Recalculate total
                    calc();
                    
                    const calcCount = calculationHistory.length;
                    alert(`Score data loaded successfully! Total calculations in history: ${calcCount}`);
                } catch (error) {
                    alert('Error loading Excel file: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
            input.value = ''; // Reset file input
        }
        
        // Load from new history format
        function loadFromHistoryFormat(wb) {
            const historyWs = wb.Sheets["Calculation History"];
            const historyData = XLSX.utils.sheet_to_json(historyWs, {header: 1});
            
            // Find the start of calculation data
            let dataStartRow = -1;
            for (let i = 0; i < historyData.length; i++) {
                if (historyData[i][0] === "Date & Time" && historyData[i][1] === "Total Score") {
                    dataStartRow = i + 1;
                    break;
                }
            }
            
            if (dataStartRow > 0) {
                // Load historical calculations
                for (let i = dataStartRow; i < historyData.length && historyData[i][0]; i++) {
                    const row = historyData[i];
                    const historicalCalc = {
                        timestamp: row[0] || "",
                        score: row[1] || "0",
                        state: {...state}, // Use current state as template
                        inspect: row[2] === "Yes" ? "20" : "0",
                        precision: "50" // Default value
                    };
                    
                    // Try to match precision tokens from text
                    if (row[3]) {
                        const precisionMatch = row[3].match(/(\d+)\s+Tokens/);
                        if (precisionMatch) {
                            const tokens = parseInt(precisionMatch[1]);
                            if (tokens === 6 || tokens === 5) historicalCalc.precision = "50";
                            else if (tokens === 4) historicalCalc.precision = "35";
                            else if (tokens === 3) historicalCalc.precision = "25";
                            else if (tokens === 2) historicalCalc.precision = "15";
                            else if (tokens === 1) historicalCalc.precision = "10";
                            else historicalCalc.precision = "0";
                        }
                    }
                    
                    calculationHistory.push(historicalCalc);
                }
            }
            
            // Load current calculation from "Current Calculation" sheet
            if (wb.SheetNames.includes("Current Calculation")) {
                loadCurrentCalculation(wb.Sheets["Current Calculation"]);
            }
        }
        
        // Load from old format
        function loadFromOldFormat(wb) {
            const sheetName = wb.SheetNames.includes("Current Calculation") ? "Current Calculation" : 
                            wb.SheetNames.includes("FLL Score") ? "FLL Score" : wb.SheetNames[0];
            const ws = wb.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(ws, {header: 1});
            
            let totalScore = "0";
            let timestamp = new Date().toLocaleString();
            let inspectValue = "0";
            let precisionValue = "50";
            
            // Parse data
            for (let i = 0; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row[0]) continue;
                
                const firstCol = row[0].toString();
                
                if (firstCol === "Total Score:") {
                    totalScore = row[1] ? row[1].toString() : "0";
                } else if (firstCol === "Date & Time:") {
                    timestamp = row[1] ? row[1].toString() : new Date().toLocaleString();
                } else if (firstCol === "Equipment Inspection") {
                    inspectValue = row[2] && row[2] !== "0" ? "20" : "0";
                } else if (firstCol === "Precision Tokens") {
                    precisionValue = row[2] ? row[2].toString() : "50";
                } else if (firstCol === "Raw Data") {
                    // Parse raw data
                    for (let j = i + 2; j < jsonData.length && jsonData[j][0]; j++) {
                        const dataRow = jsonData[j];
                        const key = dataRow[0] ? dataRow[0].toString() : "";
                        const value = parseInt(dataRow[1]) || 0;
                        
                        if (state.hasOwnProperty(key)) {
                            state[key] = value;
                        }
                    }
                    break;
                }
            }
            
            // Create historical entry
            const historicalCalc = {
                timestamp: timestamp,
                score: totalScore,
                state: {...state},
                inspect: inspectValue,
                precision: precisionValue
            };
            
            calculationHistory.push(historicalCalc);
            
            // Set current form values
            document.getElementById("inspect").value = inspectValue;
            document.getElementById("precision").value = precisionValue;
        }
        
        // Load current calculation from detailed sheet
        function loadCurrentCalculation(ws) {
            const jsonData = XLSX.utils.sheet_to_json(ws, {header: 1});
            
            for (let i = 0; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row[0]) continue;
                
                const firstCol = row[0].toString();
                
                if (firstCol === "Equipment Inspection") {
                    document.getElementById("inspect").value = row[2] && row[2] !== "0" ? "20" : "0";
                } else if (firstCol === "Precision Tokens") {
                    // Extract numeric value from the text
                    const precisionText = row[1] ? row[1].toString() : "";
                    if (precisionText.includes("50")) document.getElementById("precision").value = "50";
                    else if (precisionText.includes("35")) document.getElementById("precision").value = "35";
                    else if (precisionText.includes("25")) document.getElementById("precision").value = "25";
                    else if (precisionText.includes("15")) document.getElementById("precision").value = "15";
                    else if (precisionText.includes("10")) document.getElementById("precision").value = "10";
                    else document.getElementById("precision").value = "0";
                } else if (firstCol === "Raw Data") {
                    // Parse raw data section
                    for (let j = i + 2; j < jsonData.length && jsonData[j][0]; j++) {
                        const dataRow = jsonData[j];
                        const key = dataRow[0] ? dataRow[0].toString() : "";
                        const value = parseInt(dataRow[1]) || 0;
                        
                        if (state.hasOwnProperty(key)) {
                            state[key] = value;
                        }
                    }
                    break;
                }
            }
        }
        
        // Update form controls to match state
        function updateFormControls() {
            // Update all select and input elements
            const selects = document.querySelectorAll('select');
            selects.forEach(select => {
                if (select.id && state[select.id] !== undefined) {
                    select.value = state[select.id].toString();
                }
            });
            
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                if (input.id && state[input.id] !== undefined) {
                    input.value = state[input.id].toString();
                }
            });
            
            // Update mission-specific selects
            const missionSelects = document.querySelectorAll('.mission-card select');
            missionSelects.forEach(select => {
                const onchange = select.getAttribute('onchange');
                if (onchange && onchange.includes("u('")) {
                    const match = onchange.match(/u\('([^']+)'/);
                    if (match && state[match[1]] !== undefined) {
                        select.value = state[match[1]].toString();
                    }
                }
            });
        }

        // Initialize calculation
        calc();
    </script>

    <style>
        @keyframes highlight {
            0%, 100% { background-color: #f4ece1; }
            50% { background-color: #d4af37; }
        }
    </style>
</body>
</html>